name: build native android libraries
on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**/*.md'
      - '**/*.gitignore'
      - '**/*.gitattributes'
      
  pull_request:
    types: [opened, synchronize, reopened]  
    
  workflow_dispatch:
  
permissions:
  contents: read

env:
    BASEDIR: /__w/libpjsua2maui/libpjsua2maui
    #BCG729_PATH:  ${{ env.BASEDIR }}/lib/bcg729
    #OPENSSL_PATH: ${{ env.BASEDIR }}/lib/openssl
    #OPUS_PATH: ${{ env.BASEDIR }}/lib/opus
    #PJSIP_PATH: ${{ env.BASEDIR }}/lib/pjsip
    PJSIP_BUILD_OUT_PATH: ${{ github.workspace }}/outputs/pjsip-build-output
    SWIG_BUILD_OUT_PATH: ${{ github.workspace }}/outputs/swig-build-output
    OPENSSL_BUILD_OUT_PATH:  ${{ github.workspace }}/outputs/openssl-build-output
    OPENSSL_TARGET_NDK_LEVEL: 28
   
    OPUS_BUILD_OUT_PATH: ${{ github.workspace }}/outputs/opus-build-output
    BCG729_BUILD_OUT_PATH: ${{ github.workspace }}/outputs/bcg729-build-output
    ANDROID_BUILD_TOOLS: "34.0.0"
    TARGET_ANDROID_API: 28
    OPENH264_TMP_DIR: /tmp/openh264
jobs:
  openh264:
    runs-on: ubuntu-latest
    
    steps:
       
      - name: Checkout repository
        uses: actions/checkout@v3

       
      - name: Build Docker Image
        run: |
          docker build -t openh264-builder ${{ github.workspace }}/res/docker/openh264

       
      - name: Run Docker Container and Extract Artifacts
        run: |
          mkdir -p ${{ github.workspace }}/output/outputs
          docker run --name openh264-build -v ${{ github.workspace }}/output:/root/outputs openh264-builder
          docker cp openh264-build:/root/outputs ./output

       
      - name: Upload OpenH264 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openh264-android
          path: ./output
  
  openssl:
    runs-on: ubuntu-latest
    
    steps:
       
      - name: Checkout repository
        uses: actions/checkout@v3

       
      - name: Build Docker Image
        run: |
          docker build -t openssl-builder ${{ github.workspace }}/res/docker/openssl

       
      - name: Run Docker Container and Extract Artifacts
        run: |
          mkdir -p ${{ github.workspace }}/output/outputs
          docker run --name openssl-build -v ${{ github.workspace }}/output:/root/outputs openssl-builder
          docker cp openssl-build:/root/outputs ./output

       
      - name: Upload openssl Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openssl-android
          path: ./output
 